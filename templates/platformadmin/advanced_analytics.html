{% extends 'platformadmin/base.html' %}
{% load static %}

{% block title %}Advanced Analytics - Platform Admin{% endblock %}

{% block extra_css %}
<style>
    .analytics-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .analytics-card h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
    }
    .chart-container {
        min-height: 300px;
        position: relative;
    }
    .metric-box {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
        text-align: center;
    }
    .metric-box h4 {
        margin: 0;
        color: #666;
        font-size: 14px;
        font-weight: normal;
    }
    .metric-box .value {
        font-size: 32px;
        font-weight: bold;
        color: #007bff;
        margin: 10px 0;
    }
    .metric-box .change {
        font-size: 14px;
        color: #28a745;
    }
    .metric-box .change.negative {
        color: #dc3545;
    }
    .trend-indicator {
        display: inline-block;
        margin-left: 5px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    .export-section {
        text-align: right;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1><i class="fas fa-chart-line"></i> Advanced Analytics</h1>
            <p class="text-muted">Deep insights into platform performance and trends</p>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="form-inline">
                        <label class="mr-2">Date Range:</label>
                        <input type="date" name="start_date" class="form-control mr-2" value="{{ start_date }}">
                        <span class="mr-2">to</span>
                        <input type="date" name="end_date" class="form-control mr-2" value="{{ end_date }}">
                        <button type="submit" class="btn btn-primary">Apply</button>
                        <a href="{% url 'platformadmin:advanced_analytics' %}" class="btn btn-secondary ml-2">Reset</a>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="analytics-card">
        <h3><i class="fas fa-tachometer-alt"></i> Key Performance Indicators</h3>
        <div class="stats-grid">
            <div class="metric-box">
                <h4>Total Revenue</h4>
                <div class="value">₹{{ analytics.total_revenue|default:"0" }}</div>
                <div class="change">
                    <span class="trend-indicator">↑</span> +{{ analytics.revenue_growth|default:"0" }}%
                </div>
            </div>
            <div class="metric-box">
                <h4>Active Users</h4>
                <div class="value">{{ analytics.active_users|default:"0" }}</div>
                <div class="change">
                    <span class="trend-indicator">↑</span> +{{ analytics.user_growth|default:"0" }}%
                </div>
            </div>
            <div class="metric-box">
                <h4>Course Enrollments</h4>
                <div class="value">{{ analytics.total_enrollments|default:"0" }}</div>
                <div class="change">
                    <span class="trend-indicator">↑</span> +{{ analytics.enrollment_growth|default:"0" }}%
                </div>
            </div>
            <div class="metric-box">
                <h4>Avg. Course Rating</h4>
                <div class="value">{{ analytics.avg_rating|default:"0" }}</div>
                <div class="change">
                    <span class="trend-indicator">↑</span> +{{ analytics.rating_change|default:"0" }}
                </div>
            </div>
        </div>
    </div>

    <!-- User Growth Trends -->
    <div class="analytics-card">
        <div class="export-section">
            <a href="{% url 'platformadmin:export_users_csv' %}" class="btn btn-sm btn-success">
                <i class="fas fa-download"></i> Export Users
            </a>
        </div>
        <h3><i class="fas fa-users"></i> User Growth Trends</h3>
        <div class="chart-container">
            <canvas id="userGrowthChart"></canvas>
        </div>
        <div class="stats-grid mt-3">
            <div class="metric-box">
                <h4>New Users (30 days)</h4>
                <div class="value">{{ analytics.new_users_30d|default:"0" }}</div>
            </div>
            <div class="metric-box">
                <h4>Churn Rate</h4>
                <div class="value">{{ analytics.churn_rate|default:"0" }}%</div>
            </div>
            <div class="metric-box">
                <h4>User Retention</h4>
                <div class="value">{{ analytics.retention_rate|default:"0" }}%</div>
            </div>
        </div>
    </div>

    <!-- Revenue Analytics -->
    <div class="analytics-card">
        <div class="export-section">
            <a href="{% url 'platformadmin:export_payments_csv' %}" class="btn btn-sm btn-success">
                <i class="fas fa-download"></i> Export Payments
            </a>
        </div>
        <h3><i class="fas fa-dollar-sign"></i> Revenue Analytics</h3>
        <div class="chart-container">
            <canvas id="revenueChart"></canvas>
        </div>
        <div class="stats-grid mt-3">
            <div class="metric-box">
                <h4>Monthly Revenue</h4>
                <div class="value">₹{{ analytics.monthly_revenue|default:"0" }}</div>
            </div>
            <div class="metric-box">
                <h4>Avg. Transaction</h4>
                <div class="value">₹{{ analytics.avg_transaction|default:"0" }}</div>
            </div>
            <div class="metric-box">
                <h4>Refund Rate</h4>
                <div class="value {% if analytics.refund_rate > 10 %}change negative{% endif %}">
                    {{ analytics.refund_rate|default:"0" }}%
                </div>
            </div>
        </div>
    </div>

    <!-- Course Performance -->
    <div class="analytics-card">
        <div class="export-section">
            <a href="{% url 'platformadmin:export_courses_csv' %}" class="btn btn-sm btn-success">
                <i class="fas fa-download"></i> Export Courses
            </a>
        </div>
        <h3><i class="fas fa-graduation-cap"></i> Course Performance</h3>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Course</th>
                        <th>Teacher</th>
                        <th>Enrollments</th>
                        <th>Revenue</th>
                        <th>Rating</th>
                        <th>Completion Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course in top_courses %}
                    <tr>
                        <td>{{ course.title }}</td>
                        <td>{{ course.teacher.get_full_name }}</td>
                        <td>{{ course.enrollment_count }}</td>
                        <td>₹{{ course.total_revenue|default:"0" }}</td>
                        <td>
                            <span class="badge badge-primary">
                                {{ course.avg_rating|default:"N/A" }} ⭐
                            </span>
                        </td>
                        <td>{{ course.completion_rate|default:"0" }}%</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Platform Health -->
    <div class="analytics-card">
        <h3><i class="fas fa-heartbeat"></i> Platform Health</h3>
        <div class="stats-grid">
            <div class="metric-box">
                <h4>Payment Success Rate</h4>
                <div class="value">{{ analytics.payment_success_rate|default:"0" }}%</div>
            </div>
            <div class="metric-box">
                <h4>Avg. Response Time</h4>
                <div class="value">{{ analytics.avg_response_time|default:"0" }}ms</div>
            </div>
            <div class="metric-box">
                <h4>Active Teachers</h4>
                <div class="value">{{ analytics.active_teachers|default:"0" }}</div>
            </div>
            <div class="metric-box">
                <h4>Pending Approvals</h4>
                <div class="value">{{ analytics.pending_approvals|default:"0" }}</div>
            </div>
        </div>
        <div class="mt-3 text-right">
            <a href="{% url 'platformadmin:system_health' %}" class="btn btn-info">
                View Detailed Health Report
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    /* Django Template Variables */
    const userGrowthLabels = {{ user_growth_labels|safe|default:"[]" }};
    const userGrowthData = {{ user_growth_data|safe|default:"[]" }};
    const revenueLabels = {{ revenue_labels|safe|default:"[]" }};
    const revenueData = {{ revenue_data|safe|default:"[]" }};
    
    // User Growth Chart
    const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
    
    new Chart(userGrowthCtx, {
        type: 'line',
        data: {
            labels: userGrowthLabels,
            datasets: [{
                label: 'Total Users',
                data: userGrowthData,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    
    new Chart(revenueCtx, {
        type: 'bar',
        data: {
            labels: revenueLabels,
            datasets: [{
                label: 'Revenue (₹)',
                data: revenueData,
                backgroundColor: '#28a745',
                borderColor: '#28a745',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
{% endblock %}
