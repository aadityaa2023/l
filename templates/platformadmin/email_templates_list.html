{% extends 'platformadmin/base.html' %}
{% load humanize %}

{% block title %}Email Templates - Platform Admin{% endblock %}

{% block platformadmin_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-envelope"></i> Email Templates</h2>
    <div>
        <!-- No create/edit functionality available in current platformadmin; provide quick preview by template name -->
        <form id="preview-form" class="d-flex" onsubmit="return handlePreview(event)">
            <input id="preview-name" name="template_name" class="form-control form-control-sm me-2" placeholder="Enter template name (e.g. welcome)" />
            <button class="btn btn-sm btn-outline-primary" type="submit"><i class="fas fa-eye"></i> Preview</button>
        </form>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-2 align-items-center">
            <div class="col-auto">
                <input type="text" name="q" value="{{ request.GET.q }}" class="form-control form-control-sm" placeholder="Search templates...">
            </div>
            <div class="col-auto">
                <button class="btn btn-sm btn-outline-primary" type="submit"><i class="fas fa-search"></i> Search</button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if email_templates %}
        <div class="table-responsive">
            <table class="table table-custom mb-0">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Subject</th>
                        <th>Updated</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tpl in email_templates %}
                    <tr>
                        <td>{{ tpl.name }}</td>
                        <td>{{ tpl.subject }}</td>
                        <td>{{ tpl.updated_at|naturaltime }}</td>
                        <td class="text-end">
                            <!-- The view supports preview by template name (string); show template name if available -->
                            {% if tpl.template_name %}
                                <a href="{% url 'platformadmin:email_preview' tpl.template_name %}" class="btn btn-sm btn-outline-secondary me-2">
                                    <i class="fas fa-eye"></i> Preview
                                </a>
                            {% else %}
                                <span class="text-muted">No preview available</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                Showing {{ email_templates|length }} templates
            </div>
            <div>
                {% if page_obj %}
                    <nav class="pagination-custom">
                        <ul class="pagination mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">Previous</span></li>
                            {% endif %}
                            <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
                            {% if page_obj.has_next %}
                                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">Next</span></li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}
            </div>
        </div>

        {% else %}
            <div class="text-center py-5">
                <p class="mb-2">No email templates found.</p>
                <p class="text-muted small">Use the preview form above to test email templates by name.</p>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // small UX: auto-focus search input on load
    document.addEventListener('DOMContentLoaded', function() {
        const s = document.querySelector('input[name="q"]');
        if (s) s.focus();
    });

    function handlePreview(e) {
        e.preventDefault();
        const name = document.getElementById('preview-name').value.trim();
        if (!name) {
            alert('Enter a template name to preview (e.g. welcome)');
            return false;
        }
        const previewUrl = '/platformadmin/emails/preview/' + encodeURIComponent(name) + '/';
        window.location.href = previewUrl;
        return false;
    }
</script>
{% endblock %}
