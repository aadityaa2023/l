{% extends 'base.html' %}

{% block title %}{{ course.title }} - Learning - LeQ{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row g-0">
        <!-- Sidebar - Course Content -->
        <div class="col-lg-3 bg-white border-end" style="height: calc(100vh - 76px); overflow-y: auto;">
            <div class="p-4">
                <h5 class="fw-bold mb-3">{{ course.title }}</h5>
                <div class="progress mb-4" style="height: 8px;">
                    <div class="progress-bar" role="progressbar" style="width: {{ enrollment.progress_percentage }}%; background-color: var(--primary-color);" 
                         aria-valuenow="{{ enrollment.progress_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <p class="small text-muted mb-4">{{ enrollment.progress_percentage }}% Complete</p>
                
                <!-- Modules & Lessons -->
                <div class="accordion accordion-flush" id="modulesAccordion">
                    {% for module in modules %}
                    <div class="accordion-item border-0">
                        <h2 class="accordion-header">
                            <button class="accordion-button {% if not forloop.first %}collapsed{% endif %} px-0" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#module{{ module.id }}">
                                <div class="w-100">
                                    <div class="fw-semibold">{{ module.title }}</div>
                                    <small class="text-muted">{{ module.lessons.count }} lessons</small>
                                </div>
                            </button>
                        </h2>
                        <div id="module{{ module.id }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                             data-bs-parent="#modulesAccordion">
                            <div class="accordion-body px-0">
                                {% for lesson in module.lessons.all %}
                                          <a href="{% url 'courses:lesson_view' lesson.id %}" 
                                              class="d-block text-decoration-none py-2 px-3 rounded mb-1 {% if lesson.id == current_lesson.id %}bg-primary text-white{% else %}text-dark{% endif %} lesson-item">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            {% if lesson.id in completed_lessons %}
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            {% else %}
                                            <i class="far fa-circle me-2"></i>
                                            {% endif %}
                                            <div>
                                                <span class="small d-block">{{ lesson.title }}</span>
                                                {% if lesson.lesson_type == 'video' %}
                                                    <span class="badge badge-sm bg-danger" style="font-size: 0.65rem;">
                                                        <i class="fas fa-video"></i> Video
                                                    </span>
                                                {% endif %}
                                                {% if lesson.media_files.count > 0 %}
                                                    <span class="badge badge-sm bg-info" style="font-size: 0.65rem;">
                                                        <i class="fas fa-photo-video"></i> {{ lesson.media_files.count }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <small>{{ lesson.duration_minutes|default:0 }}m</small>
                                    </div>
                                </a>
                                {% endfor %}

                                {# Show media files nested under each lesson in the sidebar (like Udemy) #}
                                {% if module.lessons.count and lesson.media_files.count > 0 %}
                                <div class="ms-3">
                                    {% for media in lesson.media_files.all %}
                                    <a href="{% url 'courses:lesson_view' lesson.id %}#media{{ media.id }}" class="d-block small text-decoration-none py-1 px-3 rounded mb-1 {% if lesson.id == current_lesson.id %}text-primary{% else %}text-muted{% endif %}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-file me-2"></i>
                                                {{ forloop.counter }}. {{ media.title|default:media.get_media_type_display }}
                                            </div>
                                            <small class="text-muted">{{ media.duration_minutes|default:0 }}m</small>
                                        </div>
                                    </a>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Main Content - Video/Audio Player -->
        <div class="col-lg-9">
            <div class="p-4" style="height: calc(100vh - 76px); overflow-y: auto;">
                {% if current_lesson %}
                <!-- Lesson Header -->
                <div class="mb-4">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'courses:my_courses' %}">My Courses</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'courses:course_detail' course.slug %}">{{ course.title }}</a></li>
                            <li class="breadcrumb-item active">{{ current_lesson.title }}</li>
                        </ol>
                    </nav>
                    <h3 class="fw-bold">{{ current_lesson.title }}</h3>
                </div>
                
                <!-- Audio Player -->
                <div class="card-custom p-4 mb-4">
                    {% if current_lesson.lesson_type == 'video' or current_lesson.lesson_type == 'audio' %}
                        <!-- Display all media files -->
                        {% if current_lesson.media_files.all %}
                            <h5 class="fw-bold mb-3">
                                <i class="fas fa-{% if current_lesson.lesson_type == 'video' %}video{% else %}headphones{% endif %} me-2"></i>
                                Lesson Media ({{ current_lesson.media_files.count }} file{{ current_lesson.media_files.count|pluralize }})
                            </h5>
                            {% for media in current_lesson.media_files.all %}
                                <div class="mb-4" id="media{{ media.id }}">
                                    {% if media.title %}
                                        <h6 class="mb-2">{{ forloop.counter }}. {{ media.title }}</h6>
                                    {% else %}
                                        <h6 class="mb-2">{{ forloop.counter }}. {{ media.get_media_type_display }} File</h6>
                                    {% endif %}
                                    
                                    {% if media.media_type == 'video' %}
                                        <video controls class="w-100" style="max-height: 500px; border-radius: 8px;" controlsList="nodownload" preload="metadata">
                                            <source src="{{ media.get_media_url }}" type="video/mp4">
                                            Your browser does not support the video element.
                                        </video>
                                    {% else %}
                                        <audio controls class="w-100" controlsList="nodownload" preload="metadata">
                                            <source src="{{ media.get_media_url }}" type="audio/mpeg">
                                            Your browser does not support the audio element.
                                        </audio>
                                    {% endif %}
                                    
                                    {% if media.duration_minutes %}
                                        <small class="text-muted">Duration: {{ media.duration_minutes }} minutes</small>
                                    {% endif %}
                                </div>
                                {% if not forloop.last %}<hr class="my-3">{% endif %}
                            {% endfor %}
                        {% endif %}
                        
                        <!-- Legacy single audio file support -->
                        {% if current_lesson.audio_file %}
                            {% if current_lesson.media_files.all %}
                                <hr class="my-4">
                                <h6 class="mb-2">Legacy Audio File</h6>
                            {% endif %}
                            <div class="audio-player-container">
                                <audio id="audioPlayer" controls class="w-100" controlsList="nodownload" preload="metadata">
                                    <source src="{% url 'courses:serve_lesson_audio' current_lesson.id %}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                            </div>
                        {% endif %}
                        
                        <!-- No media uploaded yet -->
                        {% if not current_lesson.media_files.all and not current_lesson.audio_file %}
                            <div class="text-center py-5">
                                <i class="fas fa-{% if current_lesson.lesson_type == 'video' %}video{% else %}headphones{% endif %} fa-4x text-muted mb-3"></i>
                                <p class="text-muted">No media files uploaded yet</p>
                            </div>
                        {% endif %}
                    {% elif current_lesson.text_content %}
                    <div class="text-center py-5">
                        <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
                        <p class="text-muted">This is a text-based lesson. See the content below.</p>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-headphones fa-4x text-muted mb-3"></i>
                        <p class="text-muted">Audio content coming soon</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Lesson Navigation -->
                <div class="d-flex justify-content-between mb-4">
                    {% if previous_lesson %}
                    <a href="{% url 'courses:lesson_view' previous_lesson.id %}" class="btn btn-outline-custom">
                        <i class="fas fa-chevron-left me-2"></i>Previous Lesson
                    </a>
                    {% else %}
                    <div></div>
                    {% endif %}
                    
                    <form method="post" action="{% url 'courses:mark_lesson_complete' current_lesson.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check me-2"></i>Mark as Complete
                        </button>
                    </form>
                    
                    {% if next_lesson %}
                    <a href="{% url 'courses:lesson_view' next_lesson.id %}" class="btn btn-primary-custom">
                        Next Lesson<i class="fas fa-chevron-right ms-2"></i>
                    </a>
                    {% else %}
                    <div></div>
                    {% endif %}
                </div>
                
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-4" id="lessonTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                            <i class="fas fa-info-circle me-2"></i>Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button">
                            <i class="fas fa-sticky-note me-2"></i>Notes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="resources-tab" data-bs-toggle="tab" data-bs-target="#resources" type="button">
                            <i class="fas fa-file-download me-2"></i>Resources
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="lessonTabContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="card-custom p-4">
                            <h5 class="fw-bold mb-3">About this lesson</h5>
                            <div class="text-muted">
                                {{ current_lesson.description|linebreaks }}
                            </div>
                            
                            {% if current_lesson.transcript %}
                            <hr class="my-4">
                            <h5 class="fw-bold mb-3">Transcript</h5>
                            <div class="text-muted small">
                                {{ current_lesson.transcript|linebreaks }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Notes Tab -->
                    <div class="tab-pane fade" id="notes" role="tabpanel">
                        <div class="card-custom p-4">
                            <h5 class="fw-bold mb-4">My Notes</h5>
                            
                            <!-- Add Note Form -->
                            <form method="post" action="{% url 'courses:create_note' current_lesson.id %}" class="mb-4">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <textarea name="content" class="form-control" rows="4" placeholder="Take notes here..." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary-custom">
                                    <i class="fas fa-plus me-2"></i>Add Note
                                </button>
                            </form>
                            
                            <!-- Notes List -->
                            <div class="notes-list">
                                {% for note in notes %}
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <p class="mb-2">{{ note.content }}</p>
                                                <small class="text-muted">{{ note.created_at|timesince }} ago</small>
                                            </div>
                                            <form method="post" action="{% url 'courses:delete_note' note.id %}" class="ms-3">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-muted text-center py-4">No notes yet. Start taking notes!</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resources Tab -->
                    <div class="tab-pane fade" id="resources" role="tabpanel">
                        <div class="card-custom p-4">
                            <h5 class="fw-bold mb-4">Downloadable Resources</h5>
                            
                            {% if course.allow_download %}
                            <div class="list-group list-group-flush">
                                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-file-pdf text-danger me-2"></i>
                                        Course Materials.pdf
                                    </div>
                                    <i class="fas fa-download"></i>
                                </a>
                                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-file-audio text-primary me-2"></i>
                                        {{ current_lesson.title }}.mp3
                                    </div>
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                            {% else %}
                            <p class="text-muted text-center py-4">
                                <i class="fas fa-lock fa-3x mb-3 d-block"></i>
                                Download is not available for this course
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-book-open fa-4x text-muted mb-3"></i>
                    <h4>No lessons available yet</h4>
                    <p class="text-muted">Please check back later</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .lesson-item {
        transition: all 0.2s ease;
    }
    
    .lesson-item:hover {
        background-color: rgba(91, 81, 216, 0.1) !important;
    }
    
    audio {
        width: 100%;
        height: 54px;
        border-radius: 12px;
        outline: none;
    }
    
    audio::-webkit-media-controls-panel {
        background-color: var(--light-bg);
    }
    
    video {
        border-radius: 8px;
        background-color: #000;
    }
</style>

<script>
    // Track audio progress
    const audioPlayer = document.getElementById('audioPlayer');
    if (audioPlayer) {
        audioPlayer.addEventListener('timeupdate', function() {
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            // You can send this to backend via AJAX to track listening progress
        });
    }
</script>
{% endblock %}
