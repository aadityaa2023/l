{% extends 'base.html' %}

{% block title %}{{ course.title }} - Learning - LeQ{% endblock %}

{% block extra_css %}
<style>
footer { display: none !important; }
.bg-white { background-color: var(--bg-secondary) !important; color: var(--text-primary) !important; }
.text-dark { color: var(--text-primary) !important; }
.text-muted { color: var(--text-secondary) !important; }
.breadcrumb { background-color: var(--bg-card) !important; }
.breadcrumb-item a { color: var(--text-secondary) !important; }
.breadcrumb-item.active { color: var(--text-primary) !important; }
.card { background-color: var(--bg-card) !important; border-color: var(--border-color) !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row g-0">
        <!-- Sidebar - Course Content -->
        <div class="col-lg-3 sidebar border-end" style="height: calc(100vh - 76px); overflow-y: auto;">
            <div class="p-3 p-lg-4">
                <h5 class="fw-bold mb-3">{{ course.title }}</h5>
                <div class="progress mb-4" style="height: 8px;">
                    <div class="progress-bar" role="progressbar" style="width: {{ enrollment.progress_percentage }}%; background-color: var(--primary-color);" 
                         aria-valuenow="{{ enrollment.progress_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <p class="small text-white-50 mb-4">{{ enrollment.progress_percentage }}% Complete</p>
                
                <!-- Modules & Lessons -->
                <div class="accordion accordion-flush" id="modulesAccordion">
                    {% for module in modules %}
                    <div class="accordion-item border-0">
                        <h2 class="accordion-header">
                            <button class="accordion-button {% if not forloop.first %}collapsed{% endif %} px-0" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#module{{ module.id }}">
                                <div class="w-100">
                                    <div class="fw-semibold">{{ module.title }}</div>
                                    <small class="text-white-50">{{ module.lessons.count }} lessons</small>
                                </div>
                            </button>
                        </h2>
                        <div id="module{{ module.id }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                             data-bs-parent="#modulesAccordion">
                            <div class="accordion-body px-0">
                                {% for lesson in module.lessons.all %}
                                <a href="{% url 'courses:lesson_view' lesson.slug %}" 
                                    class="d-block text-decoration-none py-2 px-3 rounded mb-1 lesson-item {% if lesson.id == current_lesson.id %}current-lesson{% else %}text-white-50{% endif %}">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            {% if lesson.id in completed_lessons %}
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            {% else %}
                                            <i class="far fa-circle me-2"></i>
                                            {% endif %}
                                            <div class="d-flex align-items-center gap-2">
                                                {% if lesson.lesson_type == 'video' %}
                                                    <i class="fas fa-play-circle" style="opacity: 0.6; font-size: 0.85rem;"></i>
                                                {% elif lesson.lesson_type == 'audio' %}
                                                    <i class="fas fa-volume-up" style="opacity: 0.6; font-size: 0.85rem;"></i>
                                                {% elif lesson.lesson_type == 'text' %}
                                                    <i class="fas fa-file-alt" style="opacity: 0.6; font-size: 0.85rem;"></i>
                                                {% elif lesson.lesson_type == 'quiz' %}
                                                    <i class="fas fa-question-circle" style="opacity: 0.6; font-size: 0.85rem;"></i>
                                                {% endif %}
                                                <span class="small">{{ lesson.title }}</span>
                                            </div>
                                        </div>
                                        <small class="text-white-50">{{ lesson.duration_minutes|default:0 }}m</small>
                                    </div>
                                </a>

                                {# Show media files nested under each lesson in the sidebar (like Udemy) #}
                                {% if lesson.media_files.count > 0 %}
                                <div class="ms-3 mb-2">
                                    {% for media in lesson.media_files.all %}
                                    <a href="{% url 'courses:lesson_view' lesson.slug %}#media{{ media.id }}" class="d-block small text-decoration-none py-1 px-3 rounded mb-1 {% if lesson.id == current_lesson.id %}text-white{% else %}text-white-50{% endif %}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-file me-2" style="opacity:0.6"></i>
                                                {{ forloop.counter }}. {{ media.title|default:media.get_media_type_display }}
                                            </div>
                                            <small class="text-white-50">{{ media.duration_minutes|default:0 }}m</small>
                                        </div>
                                    </a>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Main Content - Video/Audio Player -->
        <div class="col-lg-9">
            <div class="p-4" style="height: calc(100vh - 76px); overflow-y: auto;">
                {% if current_lesson %}
                <!-- Lesson Header -->
                <div class="mb-4">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'courses:my_courses' %}">My Courses</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'courses:course_detail' course.slug %}">{{ course.title }}</a></li>
                            <li class="breadcrumb-item active">{{ current_lesson.title }}</li>
                        </ol>
                    </nav>
                    <h3 class="fw-bold">{{ current_lesson.title }}</h3>
                </div>
                
                <!-- Audio Player -->
                <div class="card-custom p-4 mb-4">
                    {% if current_lesson.lesson_type == 'video' or current_lesson.lesson_type == 'audio' %}
                        <!-- Click to Open Dedicated Player -->
                        {% if current_lesson.audio_file or current_lesson.media_files.all %}
                        <div class="position-relative overflow-hidden rounded-3" style="cursor: pointer; transition: all 0.3s;" onclick="window.open('{% if current_lesson.lesson_type == 'video' %}{% url 'courses:lesson_video_player' current_lesson.slug %}{% else %}{% url 'courses:lesson_audio_player' current_lesson.slug %}{% endif %}', '_blank')">
                            <!-- Thumbnail/Cover -->
                            <div class="ratio ratio-16x9 bg-dark">
                                {% if course.thumbnail %}
                                    <img src="{{ course.thumbnail.url }}" alt="{{ current_lesson.title }}" class="object-fit-cover" style="transition: transform 0.3s;">
                                {% else %}
                                    <div class="d-flex align-items-center justify-content-center">
                                        <i class="fas fa-{% if current_lesson.lesson_type == 'video' %}video{% else %}headphones{% endif %} fa-5x text-white opacity-25"></i>
                                    </div>
                                {% endif %}
                                
                                <!-- Play Overlay -->
                                <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background: rgba(0,0,0,0.5); transition: all 0.3s;">
                                    <div class="text-center">
                                        <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center player-btn" style="width: 80px; height: 80px; transition: all 0.3s;">
                                            <i class="fas fa-play text-primary" style="font-size: 32px; margin-left: 5px;"></i>
                                        </div>
                                        <p class="text-white mt-3 mb-0 fw-bold">
                                            {% if current_lesson.lesson_type == 'video' %}
                                                Click to Open Video Player
                                            {% else %}
                                                Click to Open Audio Player
                                            {% endif %}
                                        </p>
                                        <p class="text-white-50 small mb-0">
                                            {% if current_lesson.duration_minutes %}
                                                <i class="fas fa-clock me-1"></i>{{ current_lesson.duration_minutes }} minutes
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress Info -->
                        {% if lesson_progress and lesson_progress.completion_percentage > 0 %}
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Your Progress</small>
                                <small class="text-muted fw-bold">{{ lesson_progress.completion_percentage|floatformat:0 }}%</small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: {{ lesson_progress.completion_percentage }}%"></div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% else %}
                        <!-- No media uploaded yet -->
                        <div class="text-center py-5">
                            <i class="fas fa-{% if current_lesson.lesson_type == 'video' %}video{% else %}headphones{% endif %} fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">No media files uploaded yet</h5>
                            <p class="text-muted mb-0 small">The teacher will upload the lesson content soon.</p>
                        </div>
                        {% endif %}
                    {% elif current_lesson.text_content %}
                    <div class="text-center py-5">
                        <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
                        <p class="text-muted">This is a text-based lesson. See the content below.</p>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-headphones fa-4x text-muted mb-3"></i>
                        <p class="text-muted">Audio content coming soon</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Lesson Navigation -->
                <div class="d-flex justify-content-between mb-4">
                    {% if previous_lesson %}
                    <a href="{% url 'courses:lesson_view' previous_lesson.slug %}" class="btn btn-outline-custom">
                        <i class="fas fa-chevron-left me-2"></i>Previous Lesson
                    </a>
                    {% else %}
                    <div></div>
                    {% endif %}
                    
                    <form method="post" action="{% url 'courses:mark_lesson_complete' current_lesson.slug %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check me-2"></i>Mark as Complete
                        </button>
                    </form>
                    
                    {% if next_lesson %}
                    <a href="{% url 'courses:lesson_view' next_lesson.slug %}" class="btn btn-primary-custom">
                        Next Lesson<i class="fas fa-chevron-right ms-2"></i>
                    </a>
                    {% else %}
                    <div></div>
                    {% endif %}
                </div>
                
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-4" id="lessonTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                            <i class="fas fa-info-circle me-2"></i>Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button">
                            <i class="fas fa-sticky-note me-2"></i>Notes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="resources-tab" data-bs-toggle="tab" data-bs-target="#resources" type="button">
                            <i class="fas fa-file-download me-2"></i>Resources
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="lessonTabContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="card-custom p-4">
                            <h5 class="fw-bold mb-3">About this lesson</h5>
                            <div class="text-muted">
                                {{ current_lesson.description|linebreaks }}
                            </div>
                            
                            {% if current_lesson.transcript %}
                            <hr class="my-4">
                            <h5 class="fw-bold mb-3">Transcript</h5>
                            <div class="text-muted small">
                                {{ current_lesson.transcript|linebreaks }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Notes Tab -->
                    <div class="tab-pane fade" id="notes" role="tabpanel">
                        <div class="card-custom p-4">
                            <h5 class="fw-bold mb-4">My Notes</h5>
                            
                            <!-- Add Note Form -->
                            <form method="post" action="{% url 'courses:create_note' current_lesson.slug %}" class="mb-4">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <textarea name="content" class="form-control" rows="4" placeholder="Take notes here..." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary-custom">
                                    <i class="fas fa-plus me-2"></i>Add Note
                                </button>
                            </form>
                            
                            <!-- Notes List -->
                            <div class="notes-list">
                                {% for note in notes %}
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <p class="mb-2">{{ note.content }}</p>
                                                <small class="text-muted">{{ note.created_at|timesince }} ago</small>
                                            </div>
                                            <form method="post" action="{% url 'courses:delete_note' note.id %}" class="ms-3">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-muted text-center py-4">No notes yet. Start taking notes!</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resources Tab -->
                    <div class="tab-pane fade" id="resources" role="tabpanel">
                        <div class="card-custom p-4">
                            <h5 class="fw-bold mb-4">Downloadable Resources</h5>
                            
                            {% if course.allow_download %}
                            <div class="list-group list-group-flush">
                                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-file-pdf text-danger me-2"></i>
                                        Course Materials.pdf
                                    </div>
                                    <i class="fas fa-download"></i>
                                </a>
                                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-file-audio text-primary me-2"></i>
                                        {{ current_lesson.title }}.mp3
                                    </div>
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                            {% else %}
                            <p class="text-muted text-center py-4">
                                <i class="fas fa-lock fa-3x mb-3 d-block"></i>
                                Download is not available for this course
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-book-open fa-4x text-muted mb-3"></i>
                    <h4>No lessons available yet</h4>
                    <p class="text-muted">Please check back later</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    /* Sidebar styles */
    .sidebar {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .sidebar h5 {
        color: var(--text-primary);
        font-size: 1rem;
    }

    .sidebar .accordion-button {
        background: transparent;
        color: var(--text-primary);
        padding: 0.5rem 0;
        border-radius: 6px;
    }

    .sidebar .accordion-button:focus {
        box-shadow: none;
    }

    .lesson-item {
        transition: all 0.18s ease;
        padding-left: 0.6rem;
    }

    .lesson-item .fa-play-circle,
    .lesson-item .fa-volume-up,
    .lesson-item .fa-file-alt,
    .lesson-item .fa-question-circle {
        opacity: 0.7;
    }

    .lesson-item:hover {
        background-color: rgba(139,92,246,0.08) !important;
        color: var(--text-primary) !important;
    }

    /* Active/current lesson */
    .lesson-item.current-lesson {
        background: linear-gradient(90deg, rgba(139,92,246,0.15), rgba(139,92,246,0.06));
        color: var(--text-primary) !important;
        border-left: 4px solid var(--primary-color);
        padding-left: 0.4rem;
    }

    .lesson-item.current-lesson .small {
        color: var(--text-primary) !important;
    }

    /* Smaller nested media links */
    .sidebar a.small {
        font-size: 0.85rem;
    }

    /* Sidebar scrollbar tweaks */
    .sidebar::-webkit-scrollbar {
        width: 8px;
    }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 6px; }

    /* Player Card Hover Effects */
    [onclick*="player"]:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    
    [onclick*="player"]:hover img {
        transform: scale(1.05);
    }
    
    [onclick*="player"]:hover .player-btn {
        transform: scale(1.1);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }
    
    [onclick*="player"]:active {
        transform: scale(1);
    }
    
    [onclick*="player"] * {
        transition: all 0.3s ease;
    }

    /* Responsive: make sidebar collapsible on small screens */
    @media (max-width: 991px) {
        .sidebar { height: auto; max-height: 40vh; overflow-y: auto; }
        .col-lg-9 { padding-top: 1rem; }
    }

    .prose { color: var(--text-primary); }
</style>

<script>
    // No longer needed - using dedicated players
</script>
{% endblock %}
