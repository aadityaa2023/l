{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% if lesson %}{{ lesson.title }}{% else %}Audio Player{% endif %} - LeQ</title>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #121212;
            --bg-card: #1E1E1E;
            --text-main: #FFFFFF;
            --text-sub: #A0A0A0;
            --accent: #A855F7; /* Purple */
            --accent-glow: rgba(168, 85, 247, 0.4);
            --progress-bg: #333333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Gradient Background Bloom */
        .bg-bloom {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% -20%, #2a2a2a, var(--bg-dark) 60%);
            z-index: -1;
            animation: bloomPulse 10s ease-in-out infinite alternate;
        }

        @keyframes bloomPulse {
            0% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.05); }
        }

        .player-container {
            width: 100%;
            max-width: 600px; /* Increased for desktop potential */
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 24px;
            position: relative;
            margin: auto; /* Center on desktop */
        }

        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            margin-bottom: auto; /* Push down content */
        }

        /* ... icon-btn styles ... */
        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-main);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .icon-btn svg {
            width: 24px;
            height: 24px;
        }

        /* --- Vinyl Section --- */
        .vinyl-wrapper {
            flex: 2; /* Take up more space */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            width: 100%;
            /* Container for scaling context */
            container-type: inline-size;
        }
        
        /* Interactive scaling container for Vinyl + Arm */
        .vinyl-group {
            position: relative;
            width: min(80vw, 40vh, 320px);
            aspect-ratio: 1/1;
        }

        .vinyl-record {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: 
                radial-gradient(circle, #111 0%, #111 25%, #222 26%, #111 27%, #111 35%, #222 36%, #111 37%, #111 50%, #222 51%, #111 52%, #000 70%);
            box-shadow: 
                0 10px 40px rgba(0,0,0,0.6),
                inset 0 0 0 5px #333; /* Outer rim */
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: spin 8s linear infinite;
            animation-play-state: paused;
        }

        .vinyl-record::after {
            /* Shine effect */
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 40%, transparent 60%, rgba(255,255,255,0.05) 100%);
            pointer-events: none;
        }
        
        /* Album Art in Center */
        .album-art {
            width: 45%;
            height: 45%;
            border-radius: 50%;
            background-color: #333;
            background-size: cover;
            background-position: center;
            position: relative;
            z-index: 2;
            box-shadow: 0 0 0 4px #1a1a1a;
        }

        /* Tone Arm (Stylized Needle) */
        .tone-arm {
            position: absolute;
            top: -10%;
            right: -10%;
            width: 35%;
            height: 50%;
            transform-origin: top right;
            transform: rotate(-30deg);
            transition: transform 0.8s ease-in-out;
            z-index: 5;
            pointer-events: none;
            filter: drop-shadow(4px 4px 8px rgba(0,0,0,0.5));
        }

        /* SVG Tone Arm Drawing */
        .tone-arm svg {
            width: 100%;
            height: 100%;
            fill: #d1d5db;
        }

        .playing .tone-arm {
            transform: rotate(10deg); /* Moves needle onto record */
        }
        
        .playing .vinyl-record {
            animation-play-state: running;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        /* --- Track Info --- */
        .track-info {
            text-align: center;
            margin-bottom: 10px;
        }

        .track-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-artist {
            font-size: 16px;
            color: var(--text-sub);
            font-weight: 500;
        }

        /* --- Progress Arc --- */
        .progress-container {
            position: relative;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .progress-bg-path {
            fill: none;
            stroke: var(--progress-bg);
            stroke-width: 4;
            stroke-linecap: round;
        }

        .progress-active-path {
            fill: none;
            stroke: var(--accent);
            stroke-width: 4;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.1s linear;
            cursor: pointer;
        }

        /* Time Labels inside the arc curve area */
        .time-label {
            position: absolute;
            font-size: 12px;
            color: var(--text-sub);
            font-weight: 500;
        }
        .time-current { left: 20px; bottom: 30px; }
        .time-total { right: 20px; bottom: 30px; }


        /* --- Controls --- */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            margin-bottom: 30px;
        }

        .ctrl-btn {
            background: transparent;
            border: none;
            color: var(--text-main);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), color 0.2s ease;
        }

        .ctrl-btn:hover {
            color: white;
            transform: scale(1.1);
        }

        .ctrl-btn:active {
            transform: scale(0.95);
        }

        .ctrl-btn-sm svg { width: 24px; height: 24px; color: var(--text-sub); }
        .ctrl-btn-md svg { width: 32px; height: 32px; }

        .play-btn {
            width: 72px;
            height: 72px;
            background: var(--accent);
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .play-btn svg {
            width: 32px;
            height: 32px;
            fill: white;
            transition: transform 0.2s ease;
        }
        
        .play-btn:hover {
            transform: scale(1.1);
            background: #9333ea;
        }
        
        .play-btn:active {
            transform: scale(0.95);
        }

        /* --- Bottom Aux Controls --- */
        .aux-controls {
            position: absolute;
            bottom: 30px;
            right: 30px;
        }
        .aux-btn {
            width: 50px;
            height: 50px;
            background: #f1f5f9;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            color: black;
            cursor: pointer;
        }

        /* Loader */
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            pointer-events: none;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spinLoader 1s linear infinite;
        }
        @keyframes spinLoader { to { transform: rotate(360deg); } }
        .hidden { display: none; }

        /* Menu Modal */
        .menu-modal {
            position: fixed;
            bottom: 0px;
            left: 0;
            width: 100%;
            background: #222;
            border-radius: 20px 20px 0 0;
            padding: 24px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }
        .menu-modal.active {
            transform: translateY(0);
        }
        .menu-option {
            padding: 16px;
            border-bottom: 1px solid #333;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .menu-option:last-child { border-bottom: none; }
        .menu-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .menu-overlay.active { opacity: 1; pointer-events: auto; }

    </style>
</head>
<body>

    <div class="bg-bloom"></div>

    <div class="player-container {% if is_playing %}playing{% endif %}" id="playerContainer">
        
        <!-- Header -->
        <div class="header">
            <button class="icon-btn" onclick="goBack()">
                <i data-lucide="arrow-left"></i>
            </button>
            <div style="font-size: 14px; color: var(--text-sub); font-weight: 500; text-transform: uppercase; letter-spacing: 1px;">Now Playing</div>
            <button class="icon-btn" id="menuBtn">
                <i data-lucide="more-horizontal"></i>
            </button>
        </div>

        <!-- Vinyl -->
        <div class="vinyl-wrapper">
            <div class="vinyl-group">
                <div class="vinyl-record" id="vinylRecord">
                    <div class="album-art" style="background-image: url('{% if lesson.thumbnail %}{{ lesson.thumbnail.url }}{% else %}https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=300&auto=format&fit=crop{% endif %}');"></div>
                </div>
                
                <!-- Tone Arm SVG -->
                <div class="tone-arm" id="toneArm">
                    <svg viewBox="0 0 100 240" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M50 10 C 50 10, 50 0, 60 0 L 80 0 C 90 0, 90 10, 90 10 L 90 40 C 90 50, 80 50, 80 50 L 60 50 C 50 50, 50 40, 50 40 Z" fill="#4b5563"/>
                        <rect x="65" y="50" width="10" height="100" fill="#6b7280"/>
                        <rect x="60" y="150" width="20" height="40" rx="4" fill="#374151"/>
                        <path d="M70 190 L 40 220 L 50 230 L 80 200 Z" fill="#9ca3af"/>
                        <circle cx="45" cy="225" r="3" fill="#ef4444"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Track Info -->
        <div class="track-info">
            <div class="track-title">{% if lesson %}{{ lesson.title }}{% else %}Loading...{% endif %}</div>
            <div class="track-artist">{% if course %}{{ course.title }}{% else %}Audio Lesson{% endif %}</div>
        </div>

        <!-- Arc Progress Bar -->
        <div class="progress-container">
            <span class="time-label time-current" id="currentTime">0:00</span>
            
            <!-- SVG Arc -->
            <svg class="progress-svg" viewBox="0 0 300 60" preserveAspectRatio="none">
                <!-- Helper definition for the curve path -->
                <defs>
                    <!-- A quadratic bezier curve for a gentle smile shape -->
                    <!-- M 10,30 Q 150,80 290,30 -->
                    <!-- Adjusted coordinates to fit container properly -->
                    <path id="progressCurve" d="M 20,20 Q 150,70 280,20" />
                </defs>
                
                <!-- Background Rail -->
                <path d="M 20,20 Q 150,70 280,20" class="progress-bg-path" />
                
                <!-- Active Progress -->
                <!-- stroke-dasharray will be set via JS based on path length -->
                <path d="M 20,20 Q 150,70 280,20" class="progress-active-path" id="progressPath" />
                
                <!-- Interaction Hit Area (invisible thicker line) -->
                <path d="M 20,20 Q 150,70 280,20" stroke="transparent" stroke-width="20" fill="none" style="cursor: pointer;" id="progressHitArea"/>
            </svg>

            <span class="time-label time-total" id="duration">0:00</span>
        </div>

        <!-- Controls -->
        <div class="controls" style="justify-content: center; gap: 40px;">
            <button class="ctrl-btn ctrl-btn-md" id="prevBtn">
                <i data-lucide="skip-back"></i>
            </button>
            
            <button class="play-btn" id="playPauseBtn">
                <i data-lucide="play" fill="white"></i>
            </button>
            
            <button class="ctrl-btn ctrl-btn-md" id="nextBtn">
                <i data-lucide="skip-forward"></i>
            </button>
        </div>
        <!-- Magic button removed -->

    </div>

    <!-- Menus / Overlays -->
    <div class="menu-overlay" id="menuOverlay"></div>
    <div class="menu-modal" id="menuModal">
        <div class="menu-option" data-speed="1.0">
            <span>Normal Speed (1.0x)</span>
            <i data-lucide="check" class="speed-check hidden" id="check-1.0"></i>
        </div>
        <div class="menu-option" data-speed="1.25">
            <span>Speed 1.25x</span>
            <i data-lucide="check" class="speed-check hidden" id="check-1.25"></i>
        </div>
        <div class="menu-option" data-speed="1.5">
            <span>Speed 1.5x</span>
            <i data-lucide="check" class="speed-check hidden" id="check-1.5"></i>
        </div>
        <div class="menu-option" data-speed="2.0">
            <span>Speed 2.0x</span>
            <i data-lucide="check" class="speed-check hidden" id="check-2.0"></i>
        </div>
    </div>

    <!-- Loader -->
    <div class="loader hidden" id="loader">
        <div class="spinner"></div>
    </div>

    <!-- Hidden Audio -->
    <audio id="audioPlayer" preload="metadata"></audio>

    <script>
        lucide.createIcons();

        // --- Logic ---
        const audio = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const vinylRecord = document.getElementById('vinylRecord');
        const playerContainer = document.getElementById('playerContainer');
        const progressPath = document.getElementById('progressPath');
        const progressHitArea = document.getElementById('progressHitArea');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const loader = document.getElementById('loader');
        
        const menuBtn = document.getElementById('menuBtn');
        const menuModal = document.getElementById('menuModal');
        const menuOverlay = document.getElementById('menuOverlay');
        const speedOptions = document.querySelectorAll('.menu-option');

        // Audio Source
        const audioUrl = "{{ audio_url|default:''|escapejs }}";
        if (audioUrl) {
            audio.src = audioUrl;
        } else {
            console.warn("No audio URL found");
        }

        // --- SVG Arc Progress Setup ---
        // Calculate path length for dasharray
        const pathLength = progressPath.getTotalLength();
        progressPath.style.strokeDasharray = pathLength;
        progressPath.style.strokeDashoffset = pathLength; // Start empty

        function updateProgressUI(percent) {
            const offset = pathLength - (pathLength * percent / 100);
            progressPath.style.strokeDashoffset = offset;
        }

        // --- Event Listeners ---
        
        playPauseBtn.addEventListener('click', togglePlay);
        
        audio.addEventListener('play', () => {
            playerContainer.classList.add('playing');
            updatePlayButtonState(true);
        });

        audio.addEventListener('pause', () => {
            playerContainer.classList.remove('playing');
            updatePlayButtonState(false);
        });

        audio.addEventListener('timeupdate', () => {
            if (!audio.duration) return;
            const percent = (audio.currentTime / audio.duration) * 100;
            updateProgressUI(percent);
            currentTimeEl.textContent = formatTime(audio.currentTime);
        });

        audio.addEventListener('loadedmetadata', () => {
            durationEl.textContent = formatTime(audio.duration);
        });
        
        audio.addEventListener('waiting', () => loader.classList.remove('hidden'));
        audio.addEventListener('playing', () => loader.classList.add('hidden'));

        // Seek Interaction
        progressHitArea.addEventListener('click', (e) => {
            if (!audio.duration) return;
            
            // Calculate click position relative to the SVG width
            // Since it's an arc, linear mapping on X axis is a "good enough" approximation 
            // for UX, though geometrically imperfect it works well for sliders.
            const rect = progressHitArea.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const percent = Math.max(0, Math.min(1, x / rect.width));
            
            audio.currentTime = percent * audio.duration;
        });

        // Controls
        document.getElementById('prevBtn').addEventListener('click', () => {
            audio.currentTime = Math.max(0, audio.currentTime - 10);
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            audio.currentTime = Math.min(audio.duration, audio.currentTime + 10);
        });

        // Menu / Speed
        menuBtn.addEventListener('click', () => {
            menuModal.classList.add('active');
            menuOverlay.classList.add('active');
        });

        menuOverlay.addEventListener('click', () => {
            menuModal.classList.remove('active');
            menuOverlay.classList.remove('active');
        });

        speedOptions.forEach(opt => {
            opt.addEventListener('click', () => {
                const speed = parseFloat(opt.dataset.speed);
                audio.playbackRate = speed;
                
                // Update UI checkmarks
                document.querySelectorAll('.speed-check').forEach(el => el.classList.add('hidden'));
                opt.querySelector('.speed-check').classList.remove('hidden');
                
                // Close menu
                menuModal.classList.remove('active');
                menuOverlay.classList.remove('active');
            });
        });

        // --- Helpers ---

        // --- Keyboard & Media Session ---

        // Volume (Default 1) - Internal state only, no UI slider
        let savedVolume = localStorage.getItem('leq_volume');
        if (savedVolume !== null) {
            audio.volume = parseFloat(savedVolume);
        }

        function goBack() {
            // "Permanent fix": Directly navigate to the appropriate parent page
            // If the user is enrolled, go to the learning dashboard for this course.
            // If not (e.g. preview), go to the course detail/marketing page.
            {% if enrollment %}
                window.location.href = "{% url 'courses:course_learn' course.id %}";
            {% else %}
                window.location.href = "{% url 'courses:course_detail' course.slug %}";
            {% endif %}
        }

        function togglePlay() {
            if (audio.paused) {
                audio.play();
            } else {
                audio.pause();
            }
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            switch(e.key.toLowerCase()) {
                case ' ':
                case 'k':
                    e.preventDefault();
                    togglePlay();
                    break;
                case 'arrowleft':
                case 'j':
                    audio.currentTime = Math.max(0, audio.currentTime - 10);
                    break;
                case 'arrowright':
                case 'l':
                    audio.currentTime = Math.min(audio.duration, audio.currentTime + 10);
                    break;
                case 'arrowup':
                    e.preventDefault();
                    audio.volume = Math.min(1, audio.volume + 0.1);
                    volumeSlider.value = audio.volume;
                    break;
                case 'arrowdown':
                    e.preventDefault();
                    audio.volume = Math.max(0, audio.volume - 0.1);
                    volumeSlider.value = audio.volume;
                    break;
            }
        });

        // Media Session API
        if ('mediaSession' in navigator) {
            audio.addEventListener('play', () => {
                navigator.mediaSession.playbackState = 'playing';
            });
            audio.addEventListener('pause', () => {
                navigator.mediaSession.playbackState = 'paused';
            });
            
            // metadata updated in loadedmetadata if available, strictly we need song title
            const title = document.querySelector('.track-title').textContent.trim();
            const artist = document.querySelector('.track-artist').textContent.trim();
            const artwork = "{% if lesson.thumbnail %}{{ lesson.thumbnail.url }}{% endif %}";
            
            navigator.mediaSession.metadata = new MediaMetadata({
                title: title,
                artist: artist,
                artwork: artwork ? [{ src: artwork, sizes: '512x512', type: 'image/jpeg' }] : []
            });

            navigator.mediaSession.setActionHandler('play', togglePlay);
            navigator.mediaSession.setActionHandler('pause', togglePlay);
            navigator.mediaSession.setActionHandler('seekbackward', () => { audio.currentTime = Math.max(0, audio.currentTime - 10); });
            navigator.mediaSession.setActionHandler('seekforward', () => { audio.currentTime = Math.min(audio.duration, audio.currentTime + 10); });
        }

        function updatePlayButtonState(isPlaying) {
            const icon = playPauseBtn.querySelector('svg');
            // Remove old icon content
            while (icon.firstChild) {
                icon.removeChild(icon.firstChild);
            }
            
            // Set new icon (Lucide specific attributes handled by replaceWith or reset)
            // Easier way: toggle data-lucide and re-render, 
            // OR manually set innerHTML for SVG path
            
            if (isPlaying) {
                // Pause Icon
                playPauseBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause"><rect width="4" height="16" x="6" y="4"/><rect width="4" height="16" x="14" y="4"/></svg>';
            } else {
                // Play Icon
                playPauseBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play"><polygon points="6 3 20 12 6 21 6 3"/></svg>';
            }
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        // Active speed check init
        document.getElementById('check-1.0').classList.remove('hidden');

        // Progress Tracking (Legacy support)
        // Keep the progress tracking logic for backend
        const lessonId = "{% if lesson %}{{ lesson.id }}{% endif %}";
        function updateProgressTracking() {
            if (!lessonId || !audio.currentTime) return;
            const watchTime = Math.floor(audio.currentTime);
            const duration = Math.floor(audio.duration);
            const isCompleted = duration > 0 && watchTime >= duration * 0.9;
            const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
            
            fetch(`/courses/lessons/${lessonId}/progress/`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ 
                    watchTime, 
                    isCompleted,
                    playerState: audio.paused ? 4 : 3, // Simple mapping
                    playbackRate: audio.playbackRate
                })
            }).catch(err => console.error(err));
        }

        setInterval(() => {
            if (!audio.paused) updateProgressTracking();
        }, 10000);
        
        window.addEventListener('beforeunload', updateProgressTracking);

    </script>
</body>
</html>
